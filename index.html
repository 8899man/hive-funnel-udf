<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Hive-funnel-udf by yahoo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Hive-funnel-udf</h1>
      <h2 class="project-tagline">Hive UDFs for funnel analysis</h2>
      <a href="https://github.com/yahoo/hive-funnel-udf" class="btn">View on GitHub</a>
      <a href="https://github.com/yahoo/hive-funnel-udf/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/yahoo/hive-funnel-udf/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="hive-funnel-analysis-udfs" class="anchor" href="#hive-funnel-analysis-udfs" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Hive Funnel Analysis UDFs</h1>

<p><a href="https://en.wikipedia.org/wiki/Funnel_analysis">Funnel analysis</a> is a method for
tracking user conversion rates across actions. This enables detection of actions
causing high user fallout.</p>

<p>These Hive UDFs enables funnel analysis to be performed simply and easily on any
Hive table.</p>

<h2>
<a id="requirements" class="anchor" href="#requirements" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Requirements</h2>

<p><a href="https://maven.apache.org/index.html">Maven</a> is required to build the funnel
UDF.</p>

<h2>
<a id="how-to-build" class="anchor" href="#how-to-build" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>How to build</h2>

<p>There is a provided <code>Makefile</code> with all the build targets.</p>

<h3>
<a id="build-jar" class="anchor" href="#build-jar" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Build JAR</h3>

<div class="highlight highlight-source-shell"><pre>make jar</pre></div>

<p>This creates a <code>funnel.jar</code> in the <code>target/</code> directory.</p>

<h3>
<a id="register-jar-with-hive" class="anchor" href="#register-jar-with-hive" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Register JAR with Hive</h3>

<p>To use the funnel UDFs, you need to register it with Hive.</p>

<p>With temporary functions:</p>

<div class="highlight highlight-source-sql"><pre>ADD JAR <span class="pl-c1">funnel</span>.<span class="pl-c1">jar</span>;
CREATE TEMPORARY FUNCTION funnel         <span class="pl-k">AS</span> <span class="pl-s"><span class="pl-pds">'</span>com.yahoo.hive.udf.funnel.Funnel<span class="pl-pds">'</span></span>;
CREATE TEMPORARY FUNCTION funnel_merge   <span class="pl-k">AS</span> <span class="pl-s"><span class="pl-pds">'</span>com.yahoo.hive.udf.funnel.Merge<span class="pl-pds">'</span></span>;
CREATE TEMPORARY FUNCTION funnel_percent <span class="pl-k">AS</span> <span class="pl-s"><span class="pl-pds">'</span>com.yahoo.hive.udf.funnel.Percent<span class="pl-pds">'</span></span>;</pre></div>

<p>With permenant functions you need to put the JAR on HDFS, and it will be registered with a database (you have to replace <code>DATABASE</code> and <code>PATH_TO_JAR</code> with your values):</p>

<div class="highlight highlight-source-sql"><pre><span class="pl-k">CREATE</span> <span class="pl-k">FUNCTION</span> <span class="pl-en">DATABASE</span>.funnel         <span class="pl-k">AS</span> <span class="pl-s"><span class="pl-pds">'</span>com.yahoo.hive.udf.funnel.Funnel<span class="pl-pds">'</span></span>  USING JAR <span class="pl-s"><span class="pl-pds">'</span>hdfs:///PATH_TO_JAR/funnel.jar<span class="pl-pds">'</span></span>;
<span class="pl-k">CREATE</span> <span class="pl-k">FUNCTION</span> <span class="pl-en">DATABASE</span>.funnel_merge   <span class="pl-k">AS</span> <span class="pl-s"><span class="pl-pds">'</span>com.yahoo.hive.udf.funnel.Merge<span class="pl-pds">'</span></span>   USING JAR <span class="pl-s"><span class="pl-pds">'</span>hdfs:///PATH_TO_JAR/funnel.jar<span class="pl-pds">'</span></span>;
<span class="pl-k">CREATE</span> <span class="pl-k">FUNCTION</span> <span class="pl-en">DATABASE</span>.funnel_percent <span class="pl-k">AS</span> <span class="pl-s"><span class="pl-pds">'</span>com.yahoo.hive.udf.funnel.Percent<span class="pl-pds">'</span></span> USING JAR <span class="pl-s"><span class="pl-pds">'</span>hdfs:///PATH_TO_JAR/funnel.jar<span class="pl-pds">'</span></span>;</pre></div>

<h2>
<a id="how-to-use" class="anchor" href="#how-to-use" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>How to use</h2>

<p>There are three funnel UDFs provided: <a href="#funnel"><code>funnel</code></a>,
<a href="#funnel_merge"><code>funnel_merge</code></a>, <a href="#funnel_percent"><code>funnel_percent</code></a>.</p>

<p>The <a href="#funnel"><code>funnel</code></a> UDF outputs an array of longs showing conversion rates
across the provided funnels. </p>

<p>The <a href="#funnel_merge"><code>funnel_merge</code></a> UDF merges multiple arrays of longs by
adding them together.</p>

<p>The <a href="#funnel_percent"><code>funnel_percent</code></a> UDF takes a raw count funnel result and
converts it to a percent change count.</p>

<p>There is no need to sort the data on timestamp, the UDF will take care of it. If
there is a collision in the timestamps, it then sorts on the action column.</p>

<h3>
<a id="funnel" class="anchor" href="#funnel" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><code>funnel</code>
</h3>

<p><code>funnel(action_column, timestamp_column, array(funnel_1), array(funnel_2), ...)</code></p>

<ul>
<li>Builds a funnel report applied to the <code>action_column</code>, sorted by the
<code>timestamp_column</code>.</li>
<li>The funnels are arrays of the same type as the <code>action</code> column. This allows
for multiple matches to move to the next funnel.

<ul>
<li>For example, funnel_1 could be <code>array('register_button',
'facebook_invite_register')</code>. The funnel will match the first occurence
of either of these actions and proceed to the next funnel.</li>
</ul>
</li>
<li>You can have an arbitrary number of funnels.</li>
<li>The <code>timestamp_column</code> can be of any comparable type (Strings, Integers,
Dates, etc).</li>
</ul>

<h3>
<a id="funnel_merge" class="anchor" href="#funnel_merge" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><code>funnel_merge</code>
</h3>

<p><code>funnel_merge(funnel_column)</code></p>

<ul>
<li>Merges funnels. Use with funnel UDF.</li>
</ul>

<h3>
<a id="funnel_percent" class="anchor" href="#funnel_percent" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><code>funnel_percent</code>
</h3>

<p><code>funnel_percent(funnel_column)</code></p>

<ul>
<li>Converts the result of a <a href="#funnel_merge"><code>funnel_merge</code></a> to percent change.
Use with funnel and funnel_merge UDF.</li>
<li>For example, a result from <a href="#funnel_merge"><code>funnel_merge</code></a> could look like
<code>[245, 110, 54, 13]</code>. This is result is in raw counts. If we pass this
through <a href="#funnel_percent"><code>funnel_percent</code></a> then it would look like <code>[1.0,
0.44, 0.49, 0.24]</code>.</li>
</ul>

<h3>
<a id="examples" class="anchor" href="#examples" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Examples</h3>

<p>Assume a table <code>user_data</code>:</p>

<table>
<thead>
<tr>
<th>action</th>
<th>timestamp</th>
<th>user_id</th>
<th>gender</th>
</tr>
</thead>
<tbody>
<tr>
<td>signup_page</td>
<td>100</td>
<td>1</td>
<td>f</td>
</tr>
<tr>
<td>confirm_button</td>
<td>200</td>
<td>1</td>
<td>f</td>
</tr>
<tr>
<td>submit_button</td>
<td>300</td>
<td>1</td>
<td>f</td>
</tr>
<tr>
<td>signup_page</td>
<td>200</td>
<td>2</td>
<td>m</td>
</tr>
<tr>
<td>submit_button</td>
<td>400</td>
<td>2</td>
<td>m</td>
</tr>
<tr>
<td>signup_page</td>
<td>100</td>
<td>3</td>
<td>f</td>
</tr>
<tr>
<td>confirm_button</td>
<td>200</td>
<td>3</td>
<td>f</td>
</tr>
<tr>
<td>decline</td>
<td>200</td>
<td>3</td>
<td>f</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
</tbody>
</table>

<h4>
<a id="simple-funnel-signup-or-email_signup---confirm---submit" class="anchor" href="#simple-funnel-signup-or-email_signup---confirm---submit" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Simple funnel: <code>(signup OR email_signup) -&gt; confirm -&gt; submit</code>
</h4>

<div class="highlight highlight-source-sql"><pre><span class="pl-k">SELECT</span> funnel_merge(funnel)
<span class="pl-k">FROM</span> (<span class="pl-k">SELECT</span> funnel(action, <span class="pl-k">timestamp</span>, array(<span class="pl-s"><span class="pl-pds">'</span>signup_page<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>email_signup<span class="pl-pds">'</span></span>), 
                                       array(<span class="pl-s"><span class="pl-pds">'</span>confirm_button<span class="pl-pds">'</span></span>),
                                       array(<span class="pl-s"><span class="pl-pds">'</span>submit_button<span class="pl-pds">'</span></span>)) <span class="pl-k">AS</span> funnel
      <span class="pl-k">FROM</span> user_data
      <span class="pl-k">GROUP BY</span> user_id) t1;</pre></div>

<p>Result: <code>[3, 2, 1]</code></p>

<h4>
<a id="simple-funnel-with-percent-signup---confirm---submit" class="anchor" href="#simple-funnel-with-percent-signup---confirm---submit" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Simple funnel with percent: <code>signup -&gt; confirm -&gt; submit</code>
</h4>

<div class="highlight highlight-source-sql"><pre><span class="pl-k">SELECT</span> funnel_percent(funnel_merge(funnel))
<span class="pl-k">FROM</span> (<span class="pl-k">SELECT</span> funnel(action, <span class="pl-k">timestamp</span>, array(<span class="pl-s"><span class="pl-pds">'</span>signup_page<span class="pl-pds">'</span></span>), 
                                       array(<span class="pl-s"><span class="pl-pds">'</span>confirm_button<span class="pl-pds">'</span></span>),
                                       array(<span class="pl-s"><span class="pl-pds">'</span>submit_button<span class="pl-pds">'</span></span>)) <span class="pl-k">AS</span> funnel
      <span class="pl-k">FROM</span> user_data
      <span class="pl-k">GROUP BY</span> user_id) t1;</pre></div>

<p>Result: <code>[1.0, 0.66, 0.5]</code></p>

<h4>
<a id="funnel-with-multiple-groups-signup---confirm---submit-by-gender" class="anchor" href="#funnel-with-multiple-groups-signup---confirm---submit-by-gender" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Funnel with multiple groups: <code>signup -&gt; confirm -&gt; submit</code> by gender</h4>

<div class="highlight highlight-source-sql"><pre><span class="pl-k">SELECT</span> gender, funnel_merge(funnel)
<span class="pl-k">FROM</span> (<span class="pl-k">SELECT</span> gender,
             funnel(action, <span class="pl-k">timestamp</span>, array(<span class="pl-s"><span class="pl-pds">'</span>signup_page<span class="pl-pds">'</span></span>),
                                       array(<span class="pl-s"><span class="pl-pds">'</span>confirm_button<span class="pl-pds">'</span></span>),
                                       array(<span class="pl-s"><span class="pl-pds">'</span>submit_button<span class="pl-pds">'</span></span>)) <span class="pl-k">AS</span> funnel
      <span class="pl-k">FROM</span> table
      <span class="pl-k">GROUP BY</span> user_id, gender) t1;</pre></div>

<p>Result: <code>m: [1, 0, 0], f: [2, 2, 1]</code></p>

<h4>
<a id="multiple-parallel-funnels-signup---confirm---submit-and-signup---decline" class="anchor" href="#multiple-parallel-funnels-signup---confirm---submit-and-signup---decline" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Multiple parallel funnels: <code>signup -&gt; confirm -&gt; submit</code> and <code>signup -&gt; decline</code>
</h4>

<div class="highlight highlight-source-sql"><pre><span class="pl-k">SELECT</span> funnel_merge(funnel1), funnel_merge(funnel2)
<span class="pl-k">FROM</span> (<span class="pl-k">SELECT</span> funnel(action, <span class="pl-k">timestamp</span>, array(<span class="pl-s"><span class="pl-pds">'</span>signup_page<span class="pl-pds">'</span></span>),
                                       array(<span class="pl-s"><span class="pl-pds">'</span>confirm_button<span class="pl-pds">'</span></span>),
                                       array(<span class="pl-s"><span class="pl-pds">'</span>submit_button<span class="pl-pds">'</span></span>)) <span class="pl-k">AS</span> funnel1
             funnel(action, <span class="pl-k">timestamp</span>, array(<span class="pl-s"><span class="pl-pds">'</span>signup_page<span class="pl-pds">'</span></span>),
                                       array(<span class="pl-s"><span class="pl-pds">'</span>decline<span class="pl-pds">'</span></span>)) <span class="pl-k">AS</span> funnel2
      <span class="pl-k">FROM</span> table
      <span class="pl-k">GROUP BY</span> user_id) t1;</pre></div>

<p>Result: <code>[3, 2, 1] [3, 1]</code></p>

<h2>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>License</h2>

<p><a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a></p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/yahoo/hive-funnel-udf">Hive-funnel-udf</a> is maintained by <a href="https://github.com/yahoo">yahoo</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
